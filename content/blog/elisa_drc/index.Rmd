---
author: Shubham Dutta
categories:
- ELISA
- dose response
- ggplot2
- drc
- broom
date: "2023-06-08"
draft: false
excerpt: A step-by-step guide to fitting dose-response curves on ELISA data in R using `ggplot2`, `drc`, and `broom.` This tutorial walks through data preparation, visualization, curve fitting, and statistical analysis of the model.
layout: single
subtitle: A working example of how to fit dose response curves on ELISA data in R.
title: Dose response curve fitting in R
---

Here is an example of how to fit and analyse dose response data using `ggplot2`, `drc`, and `broom`. We will start by loading some packages needed for the analysis.

```{r}
#| label: setup
#| message: false
library(readr)
library(dplyr)
library(ggplot2)
library(drc)
library(broom)
```

## The data

Our data is a dose response ELISA experiment for two different antibody reagents. The data can be found [here](elisa_drc.csv).

```{r}
#| label: read-data
raw_data <- read_csv("elisa_drc.csv", show_col_types = FALSE)
glimpse(raw_data)
```

Let's focus on three variables.
-   `primary_mab_name`: Two antibodies used in the ELISA experiment.
-   `primary_mab_conc`: Antibody concentration in µg/ml (the dose).
-   `od450`: Absorbance at 450 nm (the response).

## Prepare data before plotting

Before plotting, we need to preprocess the data by subtracting the mean blank OD value from each measurement. This ensures that our response values are baseline-corrected, allowing for a more accurate dose-response analysis. The data is then grouped by antibody and concentration to compute the mean and standard deviation for each condition.

```{r}
#| label: prep-data
blank_data <- raw_data |>
    dplyr::filter(primary_mab_name == "blank")
mean_blank <- mean(blank_data[["od450"]], na.rm = TRUE)

summary <- raw_data |>
    dplyr::filter(primary_mab_name != "blank") |>
    dplyr::mutate(blanked_od = od450 - mean_blank) |>
    dplyr::group_by(primary_mab_name, primary_mab_conc) |>
    dplyr::summarise(
      mean_od = mean(blanked_od, na.rm = TRUE),
      mean_sd = sd(blanked_od, na.rm = TRUE),
      .groups = 'drop'
    )
head(summary)
```

## The final plot

The plot visualizes the dose-response relationship of two antibody reagents using four-parameter logistic (4PL) in the `drc` package.

```{r}
#| label: plot-data
#| message: false
theme_set(theme_bw(base_size = 20))
ggplot(summary, aes(x = primary_mab_conc, 
                    y = mean_od, 
                    group = primary_mab_name, 
                    color = primary_mab_name,
                    shape = primary_mab_name)) +
  geom_point(size = 3, stroke = 1.5) +
  geom_smooth(method = drc::drm, 
              method.args = list(fct = drc::L.4()),
              se = FALSE, linewidth = 1) +
  geom_errorbar(aes(ymin = mean_od - mean_sd,
                    ymax = mean_od + mean_sd),
                width = 0.1) +
  scale_x_log10() +
  scale_color_manual(name = NULL, values = c("#2F9D72", "#2D3047")) +
  scale_shape_manual(name = NULL, values = c(1, 2)) +
  labs(x = "Log concentration (µg/ml)",
       y = expression(OD[450]),
       color = NULL) +
  theme(legend.position = "inside",
        legend.position.inside = c(0.2, 0.7))
```

## Statistical analysis of the fit

After fitting the logistic regression model, we analyze the goodness of fit and residuals. The `tidy()`, `glance()`, and `augment()` functions from the `broom` package allow us to:

-   Extract parameter estimates, including the slope and effective dose (ED50).
-   Assess model fit statistics.
-   Examine residuals to check for systematic deviations or patterns.

```{r}
#| label: fit-data
raw_data_no_blanks <- subset(raw_data, primary_mab_name != "blank")
drm_model <- drm(formula = od450~primary_mab_conc, 
                 curveid = primary_mab_name, 
                 data = raw_data_no_blanks, 
                 fct = LL.4(names=c("Slope", "Lower", "Upper", "ED50")))
tidy(drm_model)
glance(drm_model)
```
